name: Java Caso#3 Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: ğŸš€ Build, Test & Sonar Analysis
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el cÃ³digo
      - name: â¬‡ï¸ Checkout del CÃ³digo Fuente
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para el anÃ¡lisis profundo de Sonar

      # 2. Preparar el entorno
      - name: â˜• Configurar Entorno Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 3. Permisos
      - name: ğŸ”§ Dar Permisos de EjecuciÃ³n a Gradle
        run: chmod +x ./gradlew

      # 4. CompilaciÃ³n
      - name: ğŸ—ï¸ Compilar Proyecto (Build)
        run: ./gradlew build --no-daemon

      # 5. Pruebas (Nota: 'build' ya suele correr tests, pero mantengo tu estructura)
      - name: ğŸ§ª Ejecutar Pruebas Unitarias
        run: ./gradlew test --no-daemon

      # 6. AnÃ¡lisis EstÃ¡tico
      - name: ğŸ” Analizar Calidad de CÃ³digo (SonarQube)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: ./gradlew sonar --info --no-daemon

      # 7. FinalizaciÃ³n
      - name: âœ… Notificar Ã‰xito del Pipeline
        if: success()
        run: echo "âœ… Build, pruebas y anÃ¡lisis completados exitosamente."